---
title: ''
output: bookdown::pdf_document2
date: "`r Sys.Date()`"
---

## Study Species
Brook trout are native to eastern North America, distributed from the Appalachian Mountains in northern Georgia to the coasts of Newfoundland and Labrador. They are culturally and economically important, designated as the official fish of nine US states. Brook trout are among the most popular freshwater sportfish in the US [@sportfishing2021]. They spawn in fall, and their eggs overwinter in streambed nests ("redds") to hatch in early spring [@hazzard1932]. They can reach maturity as early as one year of age, and seldom live longer than 3 years in their southern range [@donald1989; @meyer2006; @larson1985]. Brook trout are highly sensitive to water temperature and cannot withstand prolonged temperatures above 22-24$^\circ$C [@eaton1995; @wehrly2007]. Spawning is deleteriously affected by high summer and fall temperatures [@warren2012]. Redds are scoured and young brook trout are swept away by high flows during winter and spring months [@kanno2015]. Because of their high environmental specificity, brook trout are an aquatic indicator species. Due  to anthropogenic activities, they have experienced large declines, particularly in their southern native range [@hudy2008].  

Evidence suggests that if spatial synchrony occurs in brook trout, it is likely due to the Moran Effect. @kanno2016 found that seasonal air temperature and precipitation led to spatial synchrony in young-of-the-year (YOY) brook trout, but not in adults. @zorn2007 found correlations between brook trout density and spring discharge in Michigan rivers. Spatial synchrony due to the Moran Effect has been described in other stream-dwelling salmonids such as brown trout (*Salmo trutta*) [@cattaneo2003; @lobon-cervia2007a; @zorn2007]. Despite these indications of synchrony in brook trout, prior work has been limited to single datasets [i.e., @kanno2016; @zorn2007], and no study has attempted a broad-scale analysis of spatial synchrony in this species.

## Study Area and Dataset
Our study area comprised the far southern and eastern native range of brook trout in the USA, from the southern Appalachian Mountains in Georgia to Maryland (Fig. \@ref(fig:sites-map)). We compiled over 200,000 brook trout individual data in 170 stream segments from nine state and federal sources in the study region collected between 1982 and 2015 (Table \@ref(tab:sources-table)). All segments had $\geq$ 5 years of data during this time period. Conserved areas such as Great Smoky Mountains National Park, Shenandoah National Park, and several long-term study segments had richer spatial and temporal coverage. Data consisted of individual trout, samples, and stream segments. Individual trout measurements included total length (mm) and weight (g). Sample data included date and number of electrofishing passes. Stream segment data included National Hydrography Dataset Plus (NHDPlus) stream segment common identifier (COMID), latitude and longitude (decimal degrees), elevation (m), length and median width (m). Study segments were located in small headwater streams with a mean wetted width of 5.1m (Table \@ref(tab:sites-table)). We divided the northern and southern sub-regions at 37.13$^\circ$ latitude – that of the New River Valley, which aligns with a major shift in genetic patterns of this species [@kazyak2022]. The mean elevation was higher and channel slope was steeper in the southern versus northern sub-region (906m versus 462m in elevation; 6.6% versus 3.6% in slope). The maximum summer air temperature was higher in the southern sub-region (25.7$^\circ$C) than in the northern sub-region (24.6$^\circ$C).

```{r sites-map, fig.align = "center", fig.cap = "Map of 170 study stream segments where electrofishing data were available (5-28 annual samples per segment). Dotted line (37.13$^\\circ$ latitude) divides north and south sub-regions. MD = Maryland, VA = Virginia, TN = Tennessee, NC = North Carolina, GA = Georgia. Basemap: ESRI."}
knitr::include_graphics("../Results/v2.0/SE_Trout_segments_QGIS2.map.jpeg")
```

```{r sites-table}
kbl(Segment_Summary.table,
    col.names = c("", "Mean", "SD", "Mean", "SD"),
    caption = "Summary statistics for segment characteristics and climate variables (1980-2015) by sub-region. Summer: June-Sep. Winter: Dec. - Feb. Spring: Mar. - May. Sources: ORNL DAYMET, USGS NHDPlus.",
    digits = 1) %>% 
  add_header_above(c("", "North" = 2, "South" = 2))
```

All brook trout data were collected by backpack electrofishing in wadeable streams (mean site length: 128m). A combination of single- and multi-pass sampling methods (single: `r round(passes_pcts.table[1,3], 1)`%, multi: `r round(passes_pcts.table[2,3], 1)`%) were employed following standardized sampling protocols for the southern US region [@sdafstroutcommittee1992]. In multi-pass sampling, fish were removed from the stream in successive passes in temporarily blocked stream reaches to estimate capture probability and thus population size. Sampling boundaries were defined by block nets or cobble dams which serve as barriers for fish movement. Depending on stream width, one to three backpack electrofishing units were used. A majority of sampling occurred in annual surveys conducted at the same site in June - October. Samples taken in lakes and ponds, as well as observations of hatchery-born fish, were excluded. We also excluded segments with less than 10% brook trout in fish assemblages. YOY brook trout were defined as those <= 90 mm total length, and adults were defined as those >90 mm total length. We summarized the data to counts by life stage, sampling occasion, and electrofishing pass. 

To spatially match trout data with predictors, we pooled trout count and surface area surveyed across sites when multiple sites were surveyed annually in an NHDPlus stream segment (a length of a stream delineated by either its beginning and a confluence, or by two confluences [@USGS2016]; average segment length = 3.3 km). Brook trout in headwaters typically remain within several hundred meters of their hatching locations [@hudy2010; @rodriguez2002]. Thus, we pooled count data by stream segment to account for dispersal and demographic dependence within segments. On average, 34% of stream segments contained more than one collection site.

## Correlogram Analysis
We quantified the scale of spatial synchrony in YOY and adult brook trout using the nonparametric spatial covariance function in the 'ncf' package for R [@bjornstad2022; @bjornstad2001; @rcoreteam2022]. We then extracted estimates of both initial and average spatial correlation and the distances to which spatial covariance extends. We visually represented synchrony using spline correlograms, which portray the spatial decay in pairwise correlation between segments. The scale of synchrony (correlation length) can be interpreted as the distance at which confidence envelope of the spline function is significantly higher than the sample average [x-axis,@bjornstad2001]. We selected 74 stream segments with 5 years or more multi-pass electrofishing data between 1995 and 2015. We further removed segments where one life stage was never collected, resulting in 66 segments for YOY and 68 segments for adults. We conducted the correlogram analysis of the two life stages at the regional and sub-regional levels. We calculated 95% confidence intervals for the correlograms using the bootstrap algorithm in the 'ncf' package. We truncated pairwise lag distances to 2/3 the total distance observed following @fletcher2018. Abundances at each sample were predicted using the 'FSA' package for R [@ogle2022]. Using these predicted abundances, we calculated the natural log of average density (fish/1000 m$^2$) at each stream segment and year. We imputed missing data when necessary for the analyses and show in  Appendix \@ref(simulation-for-missing-data-in-correlogram-analysis) that the results were insensitive to this imputation.

We compared the magnitude and scale of spatial synchrony in brook trout to those of common climate influences on brook trout populations, including mean summer water and air temperature and winter streamflow and precipitation [@kanno2015; @kanno2016]. Observed air and water temperatures were obtained at 30-minute intervals from the US Forest Service [@li2016a]. These were measured using a network of 204 paired temperature loggers located in brook trout streams in the southeast US from 2011 to 2015 (Fig. \@ref(fig:temp-sites-map)). We summarized these temperatures to annual summer (June-September) means. Monthly streamflow estimates were obtained from the NHDPlus V2 [@USGS2016] for the stream segments used in the correlogram analysis of trout populations. We summarized these estimates to annual winter (December - February) means. Hourly observed winter precipitation (2008 - 2014) data were obtained for 51 NOAA NCEI measurement sites within the geographic extent of the trout data [Fig. \@ref(fig:temp-sites-map), @noaa2022] and summarized to annual winter (December - February) totals. 

## Hierarchical Model
We developed two Bayesian hierarchical models to infer synchrony in brook trout populations and to identify climate drivers of synchronous dynamics [@berliner1996; @wikle1998]. For both, we developed an N-mixture model [@royle2004] using a removal mechanism coupled with a log linear process model. In the first, hereafter the random effects model, we inferred brook trout count as a function of a temporal random effect and a spatiotemporal random effect. In the second, hereafter the climate effects model, we inferred brook trout count as a function of summer temperature and winter and spring streamflow. We elected to use separate models for climate and random effects after encountering convergence issues using a single, combined model (however the simulation in Appendix \@ref(simulation-for-combined-model) demonstrates that parameters are identifiable in such a model). We analyzed counts of brook trout abundance from 170 stream segments collected between 1982 and 2015.

Adapting the standard N-mixture model to allow our removal sampling data at segment $i = 1,...,n$, and year $t = 1,...,T$ for each of $j = 1,...,3$ electrofishing passes, we specified the data model

\begin{equation}
  y_{i,j,t} \sim 
    \begin{cases}
      \text{binomial}(N_{i,t}, p_s) & \text{if } j = 1\\
      \text{binomial}(N_{i,t} - \sum_{1}^{j-1}y_{i,j,t}, p_s) & \text{if } j > 1\,,
    \end{cases}
  (\#eq:observationModel)
\end{equation}

\noindent where $y_{i,j,t}$ is observed count of YOY or adult brook trout at segment $i$, pass $j$, and year $t$. We denote $N_{i,t}$ as the predicted count of the given life stage in year $t$ at segment $i$. We modeled abundance separately for passes $j > 1$ because there are $\sum_{1}^{j-1}y_{i,j,t}$ fewer individuals in the sampling area after removing them in each pass. The term $p_s$ represents the capture probability (of individuals) for data source $s = 1, ...,S$. We used informed priors for $\bm{p}$ such that $\bm{p}$ ~ $\text{beta}(0.5, 0.1)$ for YOY and $\bm{p}$ ~ $\text{beta}(0.65, 0.1)$ for adults, based on their differences in capture probability [@kanno2015]. We allowed capture probability to vary by source because sampling crew measurement is often a large source of variation in sampling efficiency [@hughes2002; @kimmel2006; @meador2005]. We modeled abundance in each pass conditional on local density $\lambda_{i,t}$ (fish/1000m$^2$) as

\begin{equation}
  N_{i,t} \sim \text{Poisson}\left(\frac{a_{i,t}}{1000}\lambda_{i,t}\right)\,,
  (\#eq:processModel1)
\end{equation}

\noindent where $a_{i,t}$ is the sum of site areas (length $*$ median wetted width) sampled for stream segment $i$ and year $t$. 

For the climate effects model, local abundance was represented as a function of three climate covariates. Daily maximum air temperature predictions for each stream segment were obtained from the DAYMET model [@thornton2014; @thornton1997; @thornton2021] using the 'daymetr' package in R [@hufkens2018]. Monthly flow percentile predictions for each stream segment were obtained from the NHDPlus V2 [@USGS2016]. We summarized summer high temperature as the mean of daily maximum predictions between June and September. We summarized winter (December - February) and spring (March - May) high flows as maximum of monthly 90th percentile flow estimates. All climate covariates were centered and scaled by stream segment. Abundance was modeled as a function of these covariates $\bm{x}_{i,t}$ using the log-link function

\begin{equation}
  \text{log}(\lambda_{i,t}) = \omega_i + \bm{x}'_{i,t}\bm{\beta}_i,
  (\#eq:processModel2)
\end{equation}

\noindent where $\omega_i$ represents average log density at segment $i$ when climate variables are set at their mean and $\bm{\beta}_i$ represents a vector of segment-specific climate covariate effects. Priors on $\omega_i$ and $\bm{\beta_}i$ were noninformative: $\omega_i \sim \text{normal}(0, 1000)$ and $\bm{\beta}_i \sim \text{normal}(\bm{\mu}_\beta, \bm{\sigma}^2_\beta)$ where $\bm{\mu}_\beta \sim \text{normal}(0, 100)$ and $\bm{\sigma}_\beta \sim \text{uniform}(0, 10)$. As a random effect, $\bm{\beta}_i$ allows the estimation of both local and overall covariate effects.

For the random effects model, local abundance was represented as a function of segment-specific intercept and two random effects:

\begin{equation}
  \text{log}(\lambda_{i,t}) = \omega_i + \epsilon_t + \gamma_{i,t}\,
  (\#eq:processModel3)
\end{equation}

\noindent Where $\omega_i$ represents average log density at segment $i$ with the diffuse normal prior $\omega_i \sim \text{normal}(0, 1000)$. The terms $\epsilon_t$ and $\gamma_{i,t}$ represent spatially- and spatiotemporally-structured random effects, respectively. The random effects are assumed to be independent with distributions $\epsilon_t \sim \text{normal}(0, \sigma^2_\epsilon), \sigma^2_\epsilon \sim \text{uniform}(0, 10)$, $\gamma_{i,t} \sim \text{normal}(0, \sigma^2_{\gamma,i})$, and $\sigma_{\gamma,i} \sim \text{uniform}(0, 10)$. The $\epsilon_t$ term represents the between-year variation in density that is synchronous to all segments, and the $\gamma_{i,t}$ term represents the variation that is segment-specific (i.e., asynchronous). 

Following @grosbois2009 and @lahoz-monfort2011, we used posterior samples of the estimated variances of the two random effect terms to derive a segment-specific intraclass correlation coefficient (ICC):

\begin{equation}
  ICC_i = \frac{\hat{\sigma}^2_\epsilon}{\hat{\sigma}^2_\epsilon + \hat{\sigma}^2_{\gamma,i}}\,.
  (\#eq:ICC)
\end{equation}

\noindent The ICC serves as a measure of synchrony of the local population in segment $i$ relative to the temporal variation averaged across all segments. Large ICC values indicated that the given segment was synchronous with the averaged temporal variation, and small ICC values indicated asynchrony. We created semivariograms of YOY and adult ICC values to check for spatial structure.

The synchronizing effects of the climate covariates in Eq. \@ref(eq:processModel2) can be estimated from the variances of the covariate coefficients ($\bm{\sigma}_\beta$). A coefficient with low variance (that is, similar effects on different populations) is one that has a strong synchronizing effect. A covariate with a high variance (differing effects on different populations) is one with a weak synchronizing effect.

We tested for the the presence of a portfolio of population responses by comparing segment-specific interannual variability in observed abundance to that of all segments following @schindler2010. We calculated the coefficient of variation in pass 1 YOY abundance for each segment, as well as in the average of pass 1 YOY abundance for all segments. A smaller coefficient of variation across all segments than in individual segments demonstrates a portfolio effect.

We fit a total of twelve models: One random effect and one climate effects model each for YOY and adults at the regional scale fit to all stream segments (hereafter the “regional” models), as well as one random effect model and one climate effect model each for YOY and adults in the northern and southern halves of the study region, hereafter the “sub-regional” models. We implemented our models utilizing Markov Chain Monte Carlo (MCMC) sampling using JAGS with the 'jagsUI' package in R [@kellner2021]. We provide code in online supplements. After a burn-in period of 5,000 samples for the covariate models and 20,000 for random effects models, three chains were run without thinning until 25,000 and 50,000 iterations were reached, respectively. All chains converged, as visually evaluated using trace plots. To evaluate the performance of our models, we completed posterior predictive checks for the test statistics of mean and coefficient of variation. These checks test for lack of fit using Bayesian $p$-values, defined as the probability that simulated data are more extreme than the observed data [@gelman2004]. Using this method, models with a lack of fit produce Bayesian $p$-values close to 0 or 1. We report posterior means as point estimates and 95% highest posterior density intervals (HPDIs) as estimates of uncertainty. Values were considered significant if their 95% HPDIs did not overlap 0.