---
title: ''
output: bookdown::pdf_document2
date: "`r Sys.Date()`"
---

## Study Species
Brook trout are native to eastern North America, distributed from the Appalachian Mountains in northern Georgia to the coasts of Newfoundland and Labrador. They are culturally and economically important, particularly in this native range. They are the official fish of nine US states. Brook trout are a charismatic game species: trout are among the most popular freshwater sportfish in the US [@sportfishing2021]. Brook trout spawn in fall, and their eggs overwinter in streambed nests ("redds") to hatch in early spring [@hazzard1932]. They can reach maturity as early as one year of age, and seldom live longer than 3 years in their southern range [@donald1989; @meyer2006; @larson1985]. Brook Trout are highly sensitive to water temperature and cannot withstand prolonged temperatures above 22-24$^\circ$C [@eaton1995; @wehrly2007]. Spawning is deleteriously effected by high summer and fall temperatures [@warren2012]. Redds are scoured and young brook trout are swept away by high flows during winter and spring months [@kanno2015]. Because of their high environmental specificity, brook trout are a common aquatic indicator species. Due  to anthropogenic activities, they have experienced tremendous declines, particularly in their southern native range [@hudy2008].  

Theoretical and empirical evidence suggests that if spatial synchrony occurs in brook trout, it is likely due to the Moran Effect. @kanno2016 found that seasonal air temperature and precipitation led to spatial synchrony in young-of-year (YOY) brook trout, but not in adults. @zorn2007a found correlations between brook trout density and spring discharge in Michigan rivers. Spatial synchrony due to the Moran Effect has been described in other stream-dwelling salmonids such as Brown Trout (*Salmo trutta*) [@cattaneo2003; @lobon-cervia2007a; @zorn2007]. Despite these indications of synchrony in brook trout, prior work has been limited to single datasets (i.e. @kanno2016; @zorn2007a), and no study has attempted a comprehensive analysis of spatial synchrony in this species.

## Study Area and Dataset
Our study area comprises the far southern and eastern native range of brook trout in the USA, from the southern Appalachian Mountains in Georgia to northern Maryland (Fig. \@ref(fig:sites-map)). We compiled brook trout data between 1982 and 2015 from eight state and federal sources in the study region (Table \@ref(tab:sources-table)). Conserved and managed areas such as Great Smoky Mountain National Park, Shenandoah National Park, and several long-term study sites had particularly high spatial and temporal coverage. Data consisted of individual trout, samples, and sites. Individual trout measurements included total length (mm) and weight (g). Sample data included date and number of electrofishing passes. Site data include National Hydrography Dataset Plus (NHDPlus) stream segment common identifier (COMID), latitude and longitude (decimal degrees), elevation (m), length and median width (m). Study sites were located in small headwater streams with a mean catchment area of 5.6 km$^2$, wetted width of 4.6 m, and elevation of 623 m (Table \@ref(tab:sites-table)). We divided the northern and southern subregions at 37.13$^\circ$ latitude – that of Radford, VA in the New River Valley.

```{r sites-map, fig.align = "center", fig.cap = "Map of 159 study stream segments. Basemap: ESRI"}
knitr::include_graphics("../Results/v1.0/SE_Trout_segments_QGIS2.map.jpeg")
```

```{r sites-table}
kable(Segment_Summary.table,
      col.names = c("", "Mean", "Median", "Maximum", "Minimum"),
      caption = "Summary statistics for climate variables and site characteristics.",
      digits = 3)
```

All brook trout data were collected by backpack electrofishing in wadeable streams. A combination of single pass and multipass sampling methods, where managers remove fish from the stream in a series of upstream passes to estimate population size, were employed (single: `r round(passes_pcts.table[1,3], 1)`%, multi: `r round(passes_pcts.table[2,3], 1)`%). Where multipass depletion sampling was conducted, standardized sampling protocols for the southern US region were followed [@troutcommittee1992]. This included the use of block nets or cobble dams to serve as barriers for movement in or out of the reach being sampled. Where natural barriers to movement existed, block nets or cobble dams were not used. Depending on stream width, 1 to three backpack electrofishing units were used. A majority of sampling occurred in annual surveys conducted at the same sites in June - October. Samples taken in lakes and ponds, as well as observations of hatchery-born fish, were excluded. We also excluded observations from sites with population makeups of less than 10% brook trout. YOY brook trout were defined as those <= 90 mm total length, while adults were defined as those >90 mm total length. We summarized the data to counts by life stage by sample occasion and electrofishing pass. 

An important consideration for our analyses was the scale of autocorrelation. While individual brook trout in some populations have been known to move great distances [@gowan1994], southern Appalachian brook trout typically remain within several hundred meters of their hatching locations [@hudy2010; @rodriguez2002]. We accounted for dispersal by summarizing brook trout observations at a scale equal to greater than that at which the species typically disperses. For this reason and to allow the association of segment-level covariates with our data, we analyzed brook trout observations by stream segment, defined by the USGS as a length of a stream delineated by either its beginning and a confluence, or by two confluences. The average stream segment length within our dataset is 3.22 km.  

## Correlogram Analysis
We quantified the scale of spatial synchrony in YOY and adult brook trout using the nonparametric spatial covariance function in the 'ncf' package for R [@bjornstad2022; @bjornstad2001; @rcoreteam2022]. From this we extracted estimates of both initial and average spatial correlation and the distances to which spatial covariance extends. We define the scale of synchrony as the distance at which the correlation between two segments is significantly higher than the sample average. This scale is commonly referred to as correlation length [@bjornstad2001]. We visually represented synchrony using spline correlograms, which portray the spatial decay in pairwise correlation between segments. In the context of a correlogram, the correlation length may be interpreted as the shortest distance at which the confidence envelope of the spline function intercepts the x-axis. We selected for segments with $\geq$ 5 years of data (hereafter “long term segments”) to ensure longevity in time series. We further filtered for observations made between the years 1995 and 2015, where density of surveys was highest and when covariates were available for the population model. Lastly, for this analysis we considered only multipass electrofishing data, which allows abundance estimates based on depletion. We calculated 95% confidence intervals for the correlograms using the bootstrap algorithm included in the 'ncf' package. We truncated pairwise lag distances to 2/3 the total distance observed following @fletcher2018.  

We compared the magnitude and scale of spatial synchrony in brook trout to those of common climate influences on brook trout populations, including summer water and air temperature and winter streamflow and precipitation. Observed summer (June-September) air and water temperatures were obtained from the US Forest Service (not sure how to cite this), and were measured using a network of paired temperature loggers located throughout the southeast US from 2011 to 2015. Winter (December-February) streamflow estimates were obtained from the NHDPlus V2 [@USGS2016]. Observed winter precipitation was obtained from the NOAA NCEI [@noaa2022]. In addition to analyzing the two life stages at the regional level, we further analyzed them at the subregional level. We used the 37.13$^\circ$ line of latitude as a cutoff. 

Abundances at each sample were predicted using the “removal” function in the 'FSA' package for R [@ogle2022]. Using these predicted abundances, we then calculated average abundance for each year, and from there the natural log of average density (fish/1000 m$^2$). This resulted in a measurement at each unique segment and year. For stream segments and years where data were not collected (47% of observations), we substituted mean log density for the given segment during the study period. A simulation study detailed in Appendix \@ref(simulation-for-missing-data-in-correlogram-analysis) demonstrates that imputation of segment means for 47% of data does not significantly change interpretations of correlograms as compared to imputation of segment means for 0% of data.  

Our spline correlogram analysis utilized Brook Trout counts from 74 segments over the 20-year period from 1995-2015. The YOY-only analysis included counts from 66 segments, while the adult-only analysis included counts from 68 segments from the same time period.

## Hierarchical Model
We used two Bayesian hierarchical models to infer synchrony in brook trout populations and to identify climate drivers of synchronous dynamics [@berliner1996: @wikle1998]. For both, we used an N-mixture data model [@royle2004] coupled with a log linear process model. In the first, hereafter the random effect model, we calculated the natural logarithm of brook trout density (fish/1000 m$^2$) as a function of a temporal random effect and a spatiotemporal random effect. In the second, hereater the climate effects model, we calculated the natural logarithm of brook trout density (fish/1000 m$^2$) as a function of summer temperature and winter and spring streamflow. We analyzed counts of brook trout abundance from 170 unique sites over a 34-year period from 1982 to 2015.  

Daily temperature predictions for each stream segment in our trout dataset were obtained from the DAYMET model [@thornton2014; @thornton1997; @thornton2021] using the 'daymetr' package in R [@hufkens2018]. Monthly flow predictions for each stream segment were obtained from the NHDPlus V2 [@USGS2016]. We summarized summer high temperature as the mean of daily 90th percentile estimates during the summer months (June-September). We summarized winter (December - February) high flows as maximum of monthly 90th percentile flow estimates. We initially included estimates of spring (March – May) streamflow, but removed them due to high (0.87, Spearman) correlation with winter streamflow. Climate variables were calculated for the years 1981 – 2015 (the earliest year for which DAYMET data were available and the latest year for which NHDPlus flow estimates were available). All covariates were centered and scaled by stream segment. 

Adapting the standard N-mixture model to allow our removal sampling data at unique segment $i = 1,...,n$, and year $t = 1,...,T$ for each of $j = 1,...,3$ electrofishing passes, we specify the data model

\begin{equation}
  y_{i,j,t} \sim 
    \begin{cases}
      \text{binomial}(n_{i,t}, p_s) & \text{if } j = 1\\
      \text{binomial}(n_{i,t} - \sum_{j=2}^{3}y_{i,j,t}, p_s) & \text{if } j > 1\,,
    \end{cases}
  (\#eq:observationModel)
\end{equation}

where $y_{i,j,t}$ is observed abundance of YOY or adult brook trout at segment $i$, pass $j$, and year $t$. We denote $n_{i,t}$ as the predicted abundance of the given life stage in year $t$ at segment $i$. The term $p_s$ represents the capture probability (of individuals) for data source $s = 1, ...,S$. $\bf{p}$ arises from the informed priors $\bm{p}$ ~ $\text{beta}(0.5, 0.1)$ for YOY and $\bm{p}$ ~ $\text{beta}(0.5, 0.1)$ for adults, reflecting their differences in capture probability [@kanno2015]. We allow capture probability to vary by source because each agency has its own protocol for data collection. We model abundance separately for passes $j > 1$ because there are $\sum_{j=2}^{3}y_{i,j,t}$ fewer individuals in the population after removing them in each pass. We modeled abundance in each pass conditional on local density $\lambda_{i,t}$ (fish/1000m$^2$) as

\begin{equation}
  N_{i,t} \sim \text{Poisson}\left(\frac{a_i}{1000}\lambda_{i,t}\right)\,,
  (\#eq:processModel1)
\end{equation}

where $a_i$ is the sum of site areas (length $*$ median wetted width) of the given stream segment. For the random effects model, local density was represented as a function of segment-specific intercept and two random effects:

\begin{equation}
  \text{log}(\lambda_{i,t}) = \alpha_i + \epsilon_t + \gamma_{i,t}\,
  (\#eq:processModel2)
\end{equation}

Where $\alpha_i$ represents average log density at site $i$ with the noninformative prior $\alpha_i \sim \text{normal}(0, 1000)$. The terms $\epsilon_t$ and $\gamma_{i,t}$ represent spatially- and spatiotemporally-structured random effects, respectively. The random effects are assumed to be independent with distributions $\epsilon_t \sim \text{normal}(0, \sigma^2_\epsilon), \sigma^2_\epsilon \sim \text{uniform}(0, 10)$, $\gamma_{i,t} \sim \text{normal}(0, \sigma^2_{\gamma,i})$ and $\sigma_{\gamma,i} \sim \text{uniform}(0, 10)$. The $\epsilon_t$ term represents the between-year variation in density that is synchronous to all segments, and the $\gamma_{i,t}$ term represents the variation that is segment-specific (i.e., asynchronous). 

Following @grosbois2009 and @lahoz-monfort2011, we then use posterior samples of the estimated variances of the two random effect terms to derive a segment-specific intraclass correlation coefficient (ICC):

\begin{equation}
  ICC_i = \frac{\hat{\sigma}^2_\epsilon}{\hat{\sigma}^2_\epsilon + \hat{\sigma}^2_{\gamma,i}}\,.
  (\#eq:ICC)
\end{equation}

The ICC serves as a measure of the relative synchrony of the local population in segment $i$ relative to the population as a whole. Large ICC values indicate that the given subpopulation is synchronous with the larger population, while small ICC values indicate asynchrony. We created semivariograms of YOY and adult ICC values to check for spatial structure. 

The synchronizing or asynchronizing effects of the climate covariates can be estimated from the ranges of the covariate coefficients ($\beta$s). A coefficient with small range (that is, similar effects on different populations) is one that has a synchronizing effect. A covariate with a large range (differing effects on different populations) is one with an asynchronizing effect.

For the climate effects model, local density was represented as a function of segment-level climate covariates $\bm{x}_{i,t}$ using the log-link function

\begin{equation}
  \text{log}(\lambda_{i,t}) = \alpha_i + \bm{x}'_{i,t}\bm{\beta}_i,
  (\#eq:processModel3)
\end{equation}

where $\alpha_i$ represents average log density at site $i$ when climate variables are set at their mean and $\bm{\beta}_i$ represents a vector of site-specific climate covariates  Priors on $\alpha_i$ and $\beta_i$ were noninformative: $\alpha_i \sim \text{normal}(0, 1000)$ and $\beta_i \sim \text{normal}(\mu_\beta, \sigma^2_\beta)$ where $\mu_\beta \sim \text{normal}(-0.5, 100)$ and $\sigma_\beta \sim \text{uniform}(0, 10)$.  

We fit a total of twelve models: One random effect and one climate effects model each for YOY and adults at the regional scale fit to all stream segments (hereafter the “regional” models), as well as one random effect model and one climate effect model each for YOY and adults in the northern and southern halves of the study region, hereafter the “subregional” models. We implemented our models utilizing Markov Chain Monte Carlo (MCMC) sampling using JAGS with the 'jagsUI' package in R [@kellner2021]. We provide code in Appendix \@ref(code-for-n-mixture-model). After a burn-in period of 5,000 samples for the covariate models and 20,000 for random effects models, three chains were run until 25,000 and 50,000 iterations were reached, respectively. All chains converged, as visually evaluated using trace plots. To evaluate the performance of our models, we completed posterior predictive checks for mean and coefficient of variation. We report posterior means as point estimates and 95% highest posterior density credible intervals as estimates of uncertainty.